<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>PET SHOW - {{ title }}</title>
    <!-- Google Font: Source Sans Pro -->
    <link
      rel="shortcut icon"
      href="/static/img/logo_favicon.png"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="/static/components/AdminLTE/plugins/fontawesome-free/css/all.min.css"
    />
    <!-- IonIcons -->
    <link
      rel="stylesheet"
      href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"
    />
    <!-- Theme style -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="/static/components/AdminLTE/dist/css/adminlte.min.css"
    />

    <title>{% block title %} PET SHOW {% endblock title %}</title>
  </head>
  <body class="sidebar-mini">
    <header></header>
    <div class="wrapper">
      <section class="content">
        <div class="container-fluid">{% block main %} {% endblock main %}</div>
      </section>
    </div>
    <footer>{% include 'partials/footer.html'%}</footer>
  </body>
  <script>
    const tbodyEl = document.querySelector("tbody");
    const tableEl = document.querySelector("table");
    let counter = 0;
    let conta = {}
    let total = 0.0
    function adicionaLinhaProduto(e) {
      e.preventDefault();
      
      tbodyEl.innerHTML += `
            <tr>
                <td>
                  <select  onchange="addListenerQuantidade(this)" id="${counter}" name="produto_id[${counter}]" class="form-control">
                    {% for produto in produtos %}
                        <option value="{{produto.id}}">{{produto.nome}} - {{produto.preco_venda}}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="number" id="quantidade${counter}" name="quantidade[${counter}]" class="form-control" oninput="calcTotal(this)"/>
                </td>
                <td>
                  <button class="btn btn-danger deleteBtn">X</button>
                </td>
            </tr>
        `;
    }

    function calcTotal(element) {
      let produtos = {{ produtos|safe }}
      let produto = produtos.find(product => parseInt(product.id) === parseInt(element.id));
      conta[String(produto.id)] = {produto_id: produto.id, preco: parseFloat(produto.preco_venda), quantidade: element.value}
      let total = Object.values(conta).map(item => (item.quantidade * item.preco))
      alert(total.reduce((a, b) => a + b, 0))
    }

    function addListenerQuantidade(element) {
      document.getElementById("quantidade"+element.id).id = element.value
      board = []

          var table = document.getElementById('tabela_produtos');
    for (var r = 1, n = table.rows.length; r < n; r++) {
        for (var c = 0, m = table.rows[r].cells.length; c < m; c++) {
            board.push(table.rows[r].cells[c].innerHTML);
        }
    }
    console.log(board)
    }

    function onDeleteRow(e) {
      if (!e.target.classList.contains("deleteBtn")) {
        return;
      }

      const btn = e.target;
      btn.closest("tr").remove();
    }

    document.getElementById("adiciona-produto").addEventListener("click", adicionaLinhaProduto);
    tableEl.addEventListener("click", onDeleteRow);
  </script>
</html>
